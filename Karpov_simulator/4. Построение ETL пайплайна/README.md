# Построение ETL пайплайна
## Airflow 

Airflow — это библиотека, позволяющая очень легко и удобно работать с расписанием и мониторингом выполняемых задач.

Интерфейс Airflow выглядит следующим образом:
![Airflow interface](https://github.com/D-e-n-mark/Yandex_and_Karpov/blob/main/Karpov_simulator/4.%20%D0%9F%D0%BE%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D0%B5%20ETL%20%D0%BF%D0%B0%D0%B9%D0%BF%D0%BB%D0%B0%D0%B9%D0%BD%D0%B0/Airflow%20interface.jpg)

DAG — это основная единица работы с Airflow, это некоторая глобальная задача, решаемая путем последовательного выполнения более мелких, редуцированных задач.

На главной страничке у нас перечислены все доступные DAGи, вкладки All, Active и Paused позволяют фильтровать DAGи в соответствии с состоянием их выполнения. У каждого DAGа стоит переключатель, отвечающий за то, активен ли DAG или нет, затем идет название, владелец, информация о запусках и их состояниях, расписание (в формате Cron), информация по последним выполненным задачам и некоторые хот-кеи для работы с DAGом: запуск мгновенно, перезагрузить и удалить.

![Airflow graph](https://github.com/D-e-n-mark/Yandex_and_Karpov/blob/main/Karpov_simulator/4.%20%D0%9F%D0%BE%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D0%B5%20ETL%20%D0%BF%D0%B0%D0%B9%D0%BF%D0%BB%D0%B0%D0%B9%D0%BD%D0%B0/Airflow%20graph.jpg)

Граф (graph) – основная логическая единица внутри Airflow

## Задание 

1. Параллельно будем обрабатывать две таблицы. В feed_actions для каждого юзера посчитаем число просмотров и лайков контента. В message_actions для каждого юзера считаем, сколько он получает и отсылает сообщений, скольким людям он пишет, сколько людей пишут ему. Каждая выгрузка должна быть в отдельном таске.

2. Далее объединяем две таблицы в одну.

3. Для этой таблицы считаем все эти метрики в разрезе по полу, возрасту и ос. Делаем три разных таска на каждый срез.

4. И финальные данные со всеми метриками записываем в отдельную таблицу в ClickHouse.

5. Каждый день таблица должна дополняться новыми данными. 

Структура финальной таблицы должна быть такая:

Дата - event_date

Название среза - dimension

Значение среза - dimension_value

Число просмотров - views

Числой лайков - likes

Число полученных сообщений - messages_received

Число отправленных сообщений - messages_sent

От скольких пользователей получили сообщения - users_received

Скольким пользователям отправили сообщение - users_sent

Срез - это os, gender и age
